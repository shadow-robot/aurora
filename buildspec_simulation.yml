version: 0.2

env:
  parameter-store:
     AWS_ACCESS_KEY : CODE_BUILD_EC2_ACCESS_KEY
     AWS_SECRET_KEY : CODE_BUILD_EC2_SECRET_KEY
phases:
  pre_build:
    commands:
      - aws configure set aws_access_key_id $AWS_ACCESS_KEY
      - aws configure set aws_secret_access_key $AWS_SECRET_KEY
  build:
    commands:
      - curl -s -L -X GET "https://5ukqdldkdf7ajhuun7k6uuzjfy0otgct.lambda-url.eu-west-2.on.aws/?CODEBUILD_BUILD_ID=$CODEBUILD_BUILD_ID&CODEBUILD_SOURCE_VERSION=$CODEBUILD_SOURCE_VERSION"
      - cd $CODEBUILD_SRC_DIR/ansible/playbooks/molecule_ec2_simulation
      - molecule --debug test --all
