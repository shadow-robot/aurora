# Copyright 2022-2023 Shadow Robot Company Ltd.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation version 2 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.

---
- name: remove nvidia-docker1 and nvidia-docker2 before installing nvidia-container-toolkit
  apt:
    name:
      - nvidia-docker
      - nvidia-docker2
    state: absent
    autoremove: yes
    purge: yes
  become: yes
  changed_when: false

- import_tasks: nvidia-container-toolkit.yml
  when: nvidia_docker | bool and not skip_nvidia|bool
  become: yes
  changed_when: false

- name: Check what graphic drivers are used
  block:
  - name: install nvidia-prime apt
    apt:
      name: nvidia-prime
      state: present
    become: yes

  - name: query prime-select
    command: prime-select query
    become: yes
    register: prime_select_results

  - name: switch driver to nvidia
    command: prime-select nvidia
    become: yes
    when: "prime_select_results.stdout != 'nvidia'"

  - name: end playbook so user can reboot
    fail:
      msg: "Your graphic driver has been switched to nvidia. Please reboot your PC and rerun the oneliner."
    when: "prime_select_results.stdout != 'nvidia'"
  
  - name: Check if nvidia-smi is installed
    stat:
      path: /usr/bin/nvidia-smi
    register: nvidia_smi_installed

  - name: end playbook so user can reboot
    fail:
      msg: "Your computer isn't using the right driver, please change it in the application Additional Drivers. Once done please reboot your PC and rerun the oneliner."
    when: not nvidia_smi_installed.stat.exists

  when: nvidia_docker | bool and not skip_nvidia|bool
