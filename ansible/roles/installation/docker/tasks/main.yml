---
- name: Check pip3 installed (will prevent reinstallation in case if pip3 was installed without Apt)
  command: pip3 --version
  register: pip_status
  ignore_errors: yes
  changed_when: pip_status.rc != 0

- name: Make sure python3-pip is present (if run-ansible.sh was not run locally)
  apt:
    name: 'python3-pip'
    state: 'present'
  when: pip_status.rc != 0
  become: yes

- name: Check the default python3 version
  command: python3 -V | cut -d ' ' -f2 | cut -d . -f1-2
  changed_when: false
  register: python3_version

- name: Make sure pip3 default version matches the python3 version (3.5, 3.6, or 3.7 etc.)
  command: cp /usr/local/bin/pip{{ python3_version.stdout }} /usr/local/bin/pip3
  changed_when: false
  become: yes

- name: Install Docker pip module
  pip:
    name: docker
    state: present
  become: yes
  changed_when: pip_status.rc != 0
  # Hack because of not idempotent behavior of pip module
  # Check this issue for details https://github.com/ansible/ansible/issues/28952

- name: Check if Docker is already installed
  stat: 'path=/etc/init.d/docker'
  register: docker_check
  ignore_errors: yes

- name: Install Docker
  import_tasks: install.yml
  when: not docker_check.stat.exists
  become: yes
