---
- name: Choosing which API call to make.
  block:
    - name: Choose Polhemus
      set_fact:
        api_url: https://5bo8nfkjk0.execute-api.eu-west-2.amazonaws.com/prod
        ecr_version: ecr
        region: eu-west-2
      when:
      - '"polhemus" in image'
      - '"binary" in image'    
    
    - name: Choose Haptx
      set_fact:
        api_url: https://5hmltg5th3.execute-api.eu-west-2.amazonaws.com/prod
        ecr_version: ecr
        region: eu-west-2
      when:
      - '"haptx" in image'
      - '"binary" in image'

    - name: Choose Production
      set_fact:
        api_url: https://wogk2adb24.execute-api.eu-west-2.amazonaws.com/prod
        ecr_version: ecr
        region: eu-west-2
      when:
      - '"binary" not in image'
      - '"public.ecr" not in image'
    
    - name: Choose Public
      set_fact:
        api_url: https://nxmol7pvn3.execute-api.eu-west-2.amazonaws.com/prod
        ecr_version: ecr-public
        region: us-east-1
      when:
      - '"public.ecr" in image'

- name: Gather access key and secret key
  uri:
    url: "{{ api_url }}"
    method: GET
    body_format: json
    status_code: [200, 202]
    return_content: yes
    headers:
      Content-Type: application/json
      x-api-key: "{{ customer_key }}"
  register: request_result

- name: Configure AWS CLI
  expect:
    command: aws configure
    responses:
      AWS Access Key ID: "{{ request_result.json.body.access_key }}"
      AWS Secret Access Key: "{{ request_result.json.body.secret_key }}"
      Default region name: "{{ region }}"
      Default output format: ""
  
- name: ecr docker get-authorization-token
  shell: "aws {{ ecr_version }} get-authorization-token {% if region == 'eu-west-2' %}--region eu-west-2{% else %}{% endif %}"
  register: ecr_command

- set_fact:
    ecr_authorization_data: "{{ (ecr_command.stdout | from_json).authorizationData['authorizationData'] }}"

- set_fact:
    ecr_credentials: "{{ (ecr_authorization_data.authorizationToken | b64decode).split(':') }}"

- name: docker_repository - Log into ECR registry and force re-authorization
  docker_login:
    registry_url: "{{ ecr_authorization_data.proxyEndpoint.rpartition('//')[2] }}"
    username: "{{ ecr_credentials[0] }}"
    password: "{{ ecr_credentials[1] }}"
    reauthorize: yes
