---
- name: Docker login
  docker_login:
    username: "{{ docker_username }}"
    password: "{{ docker_password }}"
  when: docker_username is defined and docker_password is defined
  become: yes

- name: Reading path to Python repository with Docker package
  command: "{{ ansible_python_interpreter }} -c \"import docker as _; print(_.__file__.replace('/docker/__init__.py', ''))\""
  register: python_packages_path_output
  changed_when: python_packages_path_output.rc != 0

- name: Set path to Docker Python package
  set_fact:
    python_packages_path: "{{ python_packages_path_output.stdout_lines | first }}"

- name: Append -nvidia to tag if nvidia_docker is not 0
  when: nvidia_docker | int !=0
  set_fact:
    tag: "{{ tag }}-nvidia"

- name: Set docker full image name
  set_fact:
    full_image_name: "{{ image }}:{{ tag }}"

- name: Pulling the image (containing hack for Python 3 path)
  docker_image:
    name: "{{ full_image_name }}"
    source: pull
  environment:
    PYTHONPATH: "{{ python_packages_path }}"
  become: yes
