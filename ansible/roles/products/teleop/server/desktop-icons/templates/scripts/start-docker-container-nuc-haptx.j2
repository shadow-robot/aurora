#jinja2: trim_blocks:False
#!/bin/bash
NUC_NAME={{ nuc_username }}
NUC_ADDRESS={{ nuc_address }}
LOCAL_IP=$(for ip_addr in $(hostname -I) ; do if [[ $ip_addr =~ "10.".*"10.".* ]] ;then echo $ip_addr; fi; done)

ssh $NUC_NAME@$NUC_ADDRESS CONTAINER={{ container_name }} SR_BRANCH={{ config_branch }} HAND_SERIALN={{ hand_serial }} ETH_PORT={{ ethercat_interface }} HOST_IP=$LOCAL_IP NUC_ADDRESS=$NUC_ADDRESS NUC_NAME=$NUC_NAME 'bash -s' <<'ENDSSH'
bash $(while [[ $(lsof -n -w | grep $HOST_IP | grep $NUC_ADDRESS | wc -l) == 1 ]]; do sleep 1; done ; docker exec -it rosnode kill $(rosnode machine $HOSTNAME)) &
docker stop ${CONTAINER}
docker start ${CONTAINER}
echo "Starting the container..."
sleep 3
docker exec --user user ${CONTAINER} bash -c "source /home/user/projects/shadow_robot/base_deps/devel/setup.bash;source /home/user/projects/shadow_robot/base/devel/setup.bash;roscd sr_ethercat_hand_config/launch;git checkout sr_rhand.launch;git checkout sr_lhand.launch;git checkout ${SR_BRANCH}"
docker exec --user user ${CONTAINER} bash -c "source /home/user/projects/shadow_robot/base_deps/devel/setup.bash;source /home/user/projects/shadow_robot/base/devel/setup.bash;roslaunch sr_teleop_vive_haptx teleop_demo_control.launch hand_serial:=${HAND_SERIALN} eth_port:=${ETH_PORT} 2> >(tee -a /home/user/.ros/log/stderr.log >&2)"
ENDSSH
sleep infinity
