---
- name: Include installation/docker role
  include_role:
    name: installation/docker
  vars:
    skip_nvidia: true

- name: Set chrony server ip
  set_fact:
    chrony_server_ip: "{{ groups['server'][0] }}"
  when: groups['server'] is defined

- name: Include installation/chrony-client role
  include_role:
    name: installation/chrony-client

- name: Include docker/docker-image role
  include_role:
    name: docker/docker-image
  vars:
    skip_nvidia: true

- name: Set server hostname
  set_fact:
    server_hostname: "{{ hostvars[groups['server'][0]]['ansible_host'] }}"
  when: groups['server'] is defined

- name: Include products/common/docker-container role
  include_role:
    name: products/common/docker-container
  vars:
    ros_master: "{{ server_hostname }}"
    nvidia_docker: false

- name: Pull sr-config branch inside the docker container
  include_role:
    name: products/common/docker-container
    tasks_from: products/common/docker-container/tasks/modify-container.yml
  vars:
    modify_script_name: "pull_sr_config_nuc.sh"
    modify_script_commands: "roscd sr_ethercat_hand_config;git remote set-url origin https://github.com/shadow-robot/sr-config.git;git fetch;git pull"
  when: config_branch is defined and config_branch | length > 0

- name: Include docker/aws role
  include_role:
    name: docker/aws
  when: use_aws|bool

- name: Check if the ssh public key has been generated and copied to temp_ssh_keys_path folder on machine running Ansible (server laptop)
  stat:
    path: "{{ temp_ssh_keys_path }}.pub"
  register: ssh_result
  delegate_to: 127.0.0.1

- name: Ensure the .ssh folder exists
  file:
    path: "{{ user_folder }}/.ssh/"
    mode: '700'
    state: directory

- name: Copy SSH public key from server to control machine (if it exists in server laptop)
  copy:
    src: "{{ temp_ssh_keys_path }}.pub"
    dest: "{{ ssh_keys_path }}.pub"
    mode: '644'
  when: ssh_result.stat.exists
  changed_when: false
  become: yes

- name: Register SSH public key with current user on the control machine
  authorized_key:
    user: "{{ user }}"
    key: "{{ lookup('file', '{{ temp_ssh_keys_path }}.pub') }}"
    state: present
  when: ssh_result.stat.exists
  changed_when: false
  become: yes
