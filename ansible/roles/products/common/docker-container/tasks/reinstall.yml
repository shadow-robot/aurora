---
- name: Create the shadow_hand_launcher_folder
  file:
    path: "{{ shadow_hand_launcher_folder }}"
    state: directory

- name: Creating the container which will execute setup script in terminator when started
  when: "not nvidia_docker|bool and terminator and setup_script | length > 0"
  include_tasks: create-container/with-setup-with-terminator.yml

- name: Creating the container which will execute setup script when started without terminator
  when: "not nvidia_docker|bool and not terminator and setup_script | length > 0"
  include_tasks: create-container/with-setup-no-terminator.yml

- name: Creating the container which will just start a terminator (no setup script)
  when: "not nvidia_docker|bool and terminator and setup_script | length == 0"
  include_tasks: create-container/no-setup-with-terminator.yml

- name: Creating the container which will not even start terminator (no setup script)
  when: "not nvidia_docker|bool and not terminator and setup_script | length == 0"
  include_tasks: create-container/no-setup-no-terminator.yml

- name: Creating the container which will execute setup script in terminator when started (NVIDIA)
  when: "nvidia_docker|bool and terminator and setup_script | length > 0"
  include_tasks: create-container/nvidia-with-setup-with-terminator.yml

- name: Checking out PRs and branches if pr_branches list has been specified
  block:
  - name: Creating the pull_pr_branches_and_catkin_make bash script for testing for these branches {{ pr_branches }}
    template:
      src: ../../../common/resources/templates/scripts/pull-pr-branches-and-catkin-make.j2
      dest: "{{ shadow_hand_launcher_folder }}/pull_pr_branches_and_catkin_make.sh"
      mode: '755'
    vars:
      pr_branches_value: "{{ pr_branches }}"

  - name: Copying the pull pull_pr_branches_and_catkin_make bash script into docker container
    changed_when: false
    shell: "docker cp {{ shadow_hand_launcher_folder }}/pull_pr_branches_and_catkin_make.sh {{ container_name }}:/tmp/pull_pr_branches_and_catkin_make.sh"
    become: yes

  - name: Copying the pull github_ssh_private_key into docker container
    changed_when: false
    shell: "docker cp /home/{{ user }}/.ssh/id_rsa {{ container_name }}:/home/user/.ssh/id_rsa"
    become: yes

  - name: Check-out any branches inside docker container and catkin_make
    import_tasks: modify-container.yml
    vars:
      modify_script_name: "pull_pr_branches_and_catkin_make.sh"
      modify_script_commands: "/tmp/pull_pr_branches_and_catkin_make.sh"
  when: pr_branches is defined and pr_branches | length > 0

- name: Pull sr-config branch inside the docker container
  import_tasks: modify-container.yml
  vars:
    modify_script_name: "pull_sr_config.sh"
    modify_script_commands: "roscd sr_ethercat_hand_config;git remote set-url origin https://github.com/shadow-robot/sr-config.git;git fetch;git pull"
  when: groups['simulation'] is not defined

- name: Set documentation variables for shadow_glove teleop
  set_fact:
    documentation_repo: sr_teleop_polhemus_documentation
    readthedocs_token: "{{ shadow_glove_teleop_readthedocs_token }}"
    documentation_product: teleop-polhemus
  when: glove == "shadow_glove" and skip_molecule_task is not defined

- name: Set documentation variables for haptx teleop
  set_fact:
    documentation_repo: sr_teleop_haptx_documentation
    readthedocs_token: "{{ haptx_teleop_readthedocs_token }}"
    documentation_product: teleop-haptx
  when: glove == "haptx" and skip_molecule_task is not defined

- name: Set documentation variables for arm and hand
  set_fact:
    documentation_repo: sr_dexterous_hand_and_arm_documentation
    readthedocs_token: "{{ arm_hand_readthedocs_token }}"
    documentation_product: hand-and-arm
  when:
    - "'arm_' in product"
    - skip_molecule_task is not defined

- name: Update documentation inside the docker container for teleop images
  import_tasks: modify-container.yml
  vars:
    modify_script_name: "update_documentation.sh"
    modify_script_commands: "roscd {{ documentation_repo }};curl -H 'Authorization: Token {{ readthedocs_token }}' https://shadow-robot-company-{{ documentation_product }}.readthedocs-hosted.com/_/downloads/en/latest/htmlzip/ -o temp.zip;unzip temp.zip;mv shadow-robot-company-{{ documentation_product }}-latest/ html/"
  when:
    - glove == "haptx" or glove == "shadow_glove" or "'arm_' in product"
    - skip_molecule_task is not defined
    - 'server' in groups and inventory_hostname==hostvars[groups['server'][0]]['inventory_hostname']
  ignore_errors: yes
