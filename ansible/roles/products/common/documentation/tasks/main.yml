# Copyright 2022 Shadow Robot Company Ltd.
#
# This program is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation version 2 of the License.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
# more details.
#
# You should have received a copy of the GNU General Public License along
# with this program. If not, see <http://www.gnu.org/licenses/>.

---
- name: Ensure botocore and boto3 modules are installed
  pip:
    name: [ "boto3", "botocore"]
    extra_args: "--user"
  changed_when: false

- name: Connect to Shadow AWS API
  uri:
    url: https://5vv2z6j3a7.execute-api.eu-west-2.amazonaws.com/prod
    method: GET
    return_content: yes
    headers:
      x-api-key: "{{ customer_key }}"
  register: response
  when: skip_molecule_task is not defined

- name: Set temporary AWS credentials for accessing necessary files
  set_fact:
    aws_key: "{{ response.content | regex_search('(?<=ACCESS_KEY_ID=)(.*)(?=\\nSECRET_ACCESS_KEY)', multiline=True) }}"
    aws_secret: "{{ response.content | regex_search('(?<=SECRET_ACCESS_KEY=)(.*)(?=\\nSESSION_TOKEN)', multiline=True) }}"
    aws_security_token: "{{ response.content | regex_search('(?<=SESSION_TOKEN=)(.*)(?=\\nEXPIRATION)', multiline=True) }}"
  when: skip_molecule_task is not defined

- name: Set AWS credentials for accessing necessary files (for Molecule in AWS)
  set_fact:
    aws_key: "{{ lookup('env','AWS_ACCESS_KEY') }}"
    aws_secret: "{{ lookup('env','AWS_SECRET_KEY') }}"
  when: skip_molecule_task is defined

- name: Choose documentation version
  block:
    - name: Choose Dexterous Hand Lite
      set_fact:
        documentation_folder: "documentation/dexterous_hand_lite"
        documentation_file: "dexterous-hand-lite-test.pdf"
        pub_readthedocs: https://shadow-robot-company-dexterous-hand-lite.readthedocs-hosted.com/en/latest/
        pub_icon_name: Dexterous Hand-Lite Documentation
      when:
        - "'arm_' not in product"
        - "'glove_' not in product"
        - product == 'hand_lite' or product == 'hand_extra_lite'"
        - product is defined
    
    - name: Choose Dexterous Hand
      set_fact:
        documentation_folder: "documentation/dexterous_hand"
        documentation_file: "dexterous-hand-2.1.6.pdf"
        pub_readthedocs: https://shadow-robot-company-dexterous-hand.readthedocs-hosted.com/en/2.1.6/
        pub_icon_name: Dexterous Hand Documentation
      when:
        - "'arm_' not in product"
        - "'glove_' not in product"
        - "product == 'hand_e'"
        - product is defined
    
    - name: Choose Dexterous Hand and Arm
      set_fact:
        documentation_folder: "documentation/dexterous_hand_arm"
        documentation_file: "dexterous-hand-arm-2.1.6.pdf"
      when:
        - "'arm_' in product"
        - "'glove_' not in product"
        - product is defined
    
    - name: Choose Dexterous Hand and Glove
      set_fact:
        documentation_folder: "documentation/dexterous_hand_glove"
        documentation_file: "dexterous-hand-glove-release.pdf"
      when:
        - "'arm_' not in product"
        - "'glove_' in product"
        - product is defined
    
    - name: Choose Teleop Polhemus
      set_fact:
        documentation_folder: "documentation/teleop_polhemus"
        documentation_file: "teleop-polhemus-latest.pdf"
      when:
        - glove == "shadow_glove"
        - product is not defined
    
    - name: Choose Teleop Haptx
      set_fact:
        documentation_folder: "documentation/teleop_haptx"
        documentation_file: "teleop-haptx-latest.pdf"
      when:
        - glove == "haptx"
        - product is not defined


- name: Downloading the hand manual from AWS to Desktop
  amazon.aws.aws_s3:
    aws_access_key: "{{ aws_key }}"
    aws_secret_key: "{{ aws_secret }}"
    security_token: "{{ aws_security_token }}"
    bucket: "{{ bucket_name }}"
    object: "/{{ documentation_folder }}/{{ documentation_file }}"
    dest: "{{ manual_folder }}/{{ manual_filename }}"
    mode: get
  when: skip_molecule_task is not defined
  changed_when: false

- name: Downloading the hand manual from AWS to Desktop (for Molecule in AWS)
  amazon.aws.aws_s3:
    aws_access_key: "{{ aws_key }}"
    aws_secret_key: "{{ aws_secret }}"
    bucket: "{{ bucket_name }}"
    object: "/{{ documentation_folder }}/{{ manual_filename }}"
    dest: "{{ manual_folder }}/{{ manual_filename }}"
    mode: get
  when: skip_molecule_task is defined
  changed_when: false

- name: Install the Documentation desktop icon for Dexterous Hand
  import_tasks: create-icon.yml
  vars:
    desktop_icon_png: "documentation_icon.png"
    launch_script: "shadow_launcher_doc_exec.sh"
    local_website_port_var: '7070'
    desktop_icon_name: "{{ pub_icon_name }}"
    desktop_icon_path: "{{ pub_icon_name }}"
    launch_terminal: "false"
    start_container_var: "true"
    start_server_command_var: "roscd sr_dexterous_hand_documentation/html; python3 -m http.server {{ local_website_port_var }}"
    preconditions_var: ""
    live_website_url_var: "{{ pub_readthedocs }}"
  when:
    - "'arm_' not in product"
    - "'glove_' not in product"
    - "product == 'hand_e'" or product == 'hand_lite' or product == 'hand_extra_lite'"
    - product is defined

- name: Install the Documentation desktop icon for Dexterous Hand and Arm
  include_role:
    name: products/common/web-gui-icon
  vars:
    desktop_icon_png: "documentation_icon.png"
    launch_script: "shadow_launcher_doc_exec.sh"
    local_website_port_var: '7070'
    desktop_icon_name: "Dexterous Hand and Arm Documentation"
    desktop_icon_path: "Dexterous Hand and Arm Documentation"
    launch_terminal: "false"
    start_container_var: "true"
    start_server_command_var: "roscd sr_dexterous_hand_and_arm_documentation/html; python3 -m http.server {{ local_website_port_var }}"
    preconditions_var: ""
    live_website_url_var: "{{ arm_hand_readthedocs_link }}"
  when:
    - "'arm_' in product"
    - "'glove_' not in product"
    - product is defined

- name: Install the Documentation desktop icon for Dexterous Hand and Glove
  include_role:
    name: products/common/web-gui-icon
  vars:
    desktop_icon_png: "documentation_icon.png"
    launch_script: "shadow_launcher_doc_exec.sh"
    local_website_port_var: '7070'
    desktop_icon_name: "Dexterous Hand and Glove Documentation"
    desktop_icon_path: "Dexterous Hand and Glove Documentation"
    launch_terminal: "false"
    start_container_var: "true"
    start_server_command_var: "roscd sr_dexterous_hand_glove_documentation/html; python3 -m http.server {{ local_website_port_var }}"
    preconditions_var: ""
    live_website_url_var: "{{ glove_hand_readthedocs_link }}"
  when:
    - "'arm_' not in product"
    - "'glove_' in product"
    - product is defined

- name: Install the Documentation desktop icon for HaptX
  include_role:
    name: products/common/web-gui-icon
  vars:
    desktop_icon_png: "documentation_icon.png"
    launch_script: "shadow_launcher_doc_exec.sh"
    local_website_port_var: '7070'
    desktop_icon_name: "Teleop Documentation"
    desktop_icon_path: "Teleop Documentation"
    launch_terminal: "false"
    start_container_var: "true"
    start_server_command_var: "roscd sr_teleop_haptx_documentation/html; python3 -m http.server {{ local_website_port_var }}"
    preconditions_var: ""
    live_website_url_var: "{{ haptx_teleop_readthedocs_link }}"
  when:
    - glove == "haptx"
    - product is not defined

- name: Install the Documentation desktop icon for Shadow Glove Teleop
  include_role:
    name: products/common/web-gui-icon
  vars:
    desktop_icon_png: "documentation_icon.png"
    launch_script: "shadow_launcher_doc_exec.sh"
    local_website_port_var: '7070'
    desktop_icon_name: "Teleop Documentation"
    desktop_icon_path: "Teleop Documentation"
    launch_terminal: "false"
    start_container_var: "true"
    start_server_command_var: "roscd sr_teleop_polhemus_documentation/html; python3 -m http.server {{ local_website_port_var }}"
    preconditions_var: ""
    live_website_url_var: "{{ shadow_glove_teleop_readthedocs_link }}"
  when:
    - glove == "shadow_glove"
    - product is not defined
