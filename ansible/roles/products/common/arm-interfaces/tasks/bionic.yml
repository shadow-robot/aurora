---
- name: Set default macaddress for right arm if right-arm already exists
  set_fact:
    ethercat_right_arm_mac: "{{ hostvars[groups['control_machine'][0]]['ansible_right_arm']['macaddress'] }}"
  when: "'right-arm' in ansible_interfaces"

- name: Set default macaddress for left arm if left-arm already exists
  set_fact:
    ethercat_left_arm_mac: "{{ hostvars[groups['control_machine'][0]]['ansible_left_arm']['macaddress'] }}"
  when: "'left-arm' in ansible_interfaces"

- name: Rename {{ ethercat_right_arm }} to right-arm (required for netplan) if not already done
  block:
    - name: Get {{ ethercat_right_arm }} right-arm macaddress
      set_fact:
        ethercat_right_arm_mac: "{{ hostvars[groups['control_machine'][0]]['ansible_'+ethercat_right_arm]['macaddress'] }}"

    - name: Bring down right arm ethernet interface before renaming
      command: ifconfig {{ ethercat_right_arm }} down
      become: true

    - name: Rename right arm interface to right-arm
      command: ip link set {{ ethercat_right_arm }} name right-arm
      become: true

    - name: Bring up right arm ethernet interface after renaming
      command: ifconfig right-arm up
      become: true
  when:
    - ethercat_right_arm in ansible_interfaces
    - bimanual|bool or hand_side=="right"

- name: Rename {{ ethercat_left_arm }} to left-arm (required for netplan) if not already done
  block:
    - name: Get {{ ethercat_left_arm }} left-arm macaddress
      set_fact:
        ethercat_left_arm_mac: "{{ hostvars[groups['control_machine'][0]]['ansible_'+ethercat_left_arm]['macaddress'] }}"

    - name: Bring down left arm ethernet interface before renaming
      command: ifconfig {{ ethercat_left_arm }} down
      become: true

    - name: Rename left arm interface to left-arm
      command: ip link set {{ ethercat_left_arm }} name left-arm
      become: true

    - name: Bring up left arm ethernet interface after renaming
      command: ifconfig left-arm up
      become: true
  when:
    - ethercat_left_arm in ansible_interfaces
    - bimanual|bool or hand_side=="left"

- name: Ensure the {{ netplan_file }} exists
  file:
    path: "{{ netplan_file }}"
    mode: '700'
    state: touch
  become: yes

- name: Configuring netplan for right arm
  template:
    src: templates/netplan-right.j2
    dest: "{{ netplan_file }}"
  become: true
  when: not bimanual|bool and hand_side=="right"

- name: Configuring netplan for left arm
  template:
    src: templates/netplan-left.j2
    dest: "{{ netplan_file }}"
  become: true
  when: not bimanual|bool and hand_side=="left"

- name: Configuring netplan for bimanual arms
  template:
    src: templates/netplan-bimanual.j2
    dest: "{{ netplan_file }}"
  become: true
  when: bimanual|bool

- name: Generate netplan config
  command: netplan generate
  become: true

- name: Apply netplan config
  command: netplan apply
  become: true

- name: Edit root crontab on NUC to ensure all arm interfaces come back up after reboot
  cron:
    name: "apply netplan on reboot"
    special_time: reboot
    job: "/usr/sbin/netplan apply"
    user: root
  become: true
